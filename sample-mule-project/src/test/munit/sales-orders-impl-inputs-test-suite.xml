<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<munit:config name="sales-orders-impl-inputs-test-suite.xml" />
	<munit:test name="csv-file-processing_flow-test" doc:id="e8e8e4b4-c01c-4b64-b173-c6323e5964a8" description="Test">
		<munit:behavior >
			<munit-tools:spy doc:name="Transform: CSV payload" doc:id="b53d8564-536d-4021-88e1-0e68f4b3df0f" processor="ee:transform">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="CSV payload" attributeName="doc:name" />
				</munit-tools:with-attributes>
				<munit-tools:after-call>
					<ee:transform doc:name="Expected Message" doc:id="3b5c7197-2e1c-41fd-b3bc-5709aed110b0">
						<ee:message>
						</ee:message>
						<ee:variables >
							<ee:set-variable variableName="expectedMessage" ><![CDATA[%dw 2.0
output application/json
---
[
  {
    "customerId": "0002",
    "customerName": "George Costanza",
    "salesOrderId": "A1002",
    "lineItems": [
      {
        "itemNumber": "1",
        "quantity": "2",
        "itemType": "Product",
        "pricePerUnit": "190.99",
        "itemDescription": "Microphone special for standup"
      },
      {
        "itemNumber": "2",
        "quantity": "1",
        "itemType": "Service",
        "pricePerUnit": "1000.88",
        "itemDescription": "Car Wash, Full Service"
      },
      {
        "itemNumber": "3",
        "quantity": "4",
        "itemType": "Product",
        "pricePerUnit": "20.77",
        "itemDescription": "Ball for Bowling"
      },
      {
        "itemNumber": "4",
        "quantity": "1",
        "itemType": "Service",
        "pricePerUnit": "30.66",
        "itemDescription": "Haircut"
      },
      {
        "itemNumber": "5",
        "quantity": "1",
        "itemType": "Service",
        "pricePerUnit": "20.55",
        "itemDescription": "Shaving"
      }
    ]
  },
  {
    "customerId": "0003",
    "customerName": "Cosmo Kramer",
    "salesOrderId": "A1003",
    "lineItems": [
      {
        "itemNumber": "1",
        "quantity": "2",
        "itemType": "Product",
        "pricePerUnit": "190.44",
        "itemDescription": "Microphone special for standup"
      },
      {
        "itemNumber": "2",
        "quantity": "1",
        "itemType": "Service",
        "pricePerUnit": "1000.33",
        "itemDescription": "Car Wash, Full Service"
      },
      {
        "itemNumber": "3",
        "quantity": "4",
        "itemType": "Product",
        "pricePerUnit": "20.22",
        "itemDescription": "Ball for Bowling"
      }
    ]
  }
]]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
					<munit-tools:assert-that doc:name="Payload is equal to expected message" doc:id="5dc2ed3c-b49a-4403-84cb-2c1f53610576" is="#[MunitTools::equalTo((vars.expectedMessage filter $.customerId == '0002'))]" expression="#[(payload filter $.customerId == '0002')]"/>
					<munit-tools:assert-that doc:name="Payload is equal to expected message" doc:id="c63a52bc-d31e-4dd3-b4c2-5155d6ffe004" expression="#[(payload filter $.customerId == '0003')]" is="#[MunitTools::equalTo((vars.expectedMessage filter $.customerId == '0003'))]" />
				</munit-tools:after-call>
			</munit-tools:spy>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Read CSV" doc:id="be037217-f1b3-4cc3-b4d7-62a0121ef259">
				<munit:payload value="#[output application/csv --- readUrl('classpath://sample_data/sales_orders_multiple.csv','application/csv')]" encoding="UTF-8" mediaType="application/csv" />
			</munit:set-event>
			<flow-ref doc:name="csv-file-processing" doc:id="79f7c95c-a693-4d68-abe1-48d21c07acfd" name="csv-file-processing"/>
		</munit:execution>
		<munit:validation >
			<munit-tools:verify-call doc:name="Publish SalesOrdersQueue (2 times)" doc:id="c6b9e45e-ba46-47a9-a0d9-df6473026372" processor="vm:publish" times="2">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="Publish SalesOrdersQueue" attributeName="doc:name" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>
	<munit:test name="csv-file-processing_error-test" doc:id="7be9a351-160a-424c-8a52-01fc21891e78" >
		<munit:execution >
			<munit:set-event doc:name="Read CSV" doc:id="01d6e04d-145b-4427-abe3-d966c25b6c60" >
				<munit:payload value="#[output application/csv --- readUrl('classpath://sample_data/invalid_csv_file.csv','application/csv')]" encoding="UTF-8" mediaType="application/csv" />
			</munit:set-event>
			<flow-ref doc:name="csv-file-processing" doc:id="73104cfd-7c7a-4356-b4a7-d0c55cc5a540" name="csv-file-processing" />
		</munit:execution>
		<munit:validation >
			<munit-tools:verify-call doc:name="Incorrect Format CSV (1 Time)" doc:id="42373b62-52a3-4aab-8758-d54cf16fe8cb" processor="avio-core:custom-logger" times="1">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="Incorrect Format CSV" attributeName="doc:name" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>
	<munit:test name="queue-publish-message-for-processing_full-flow-test" doc:id="adb58236-8369-4b70-8980-25fadd897a20" description="Test">
		<munit:behavior >
			<munit-tools:spy doc:name="Transform Response" doc:id="caa4ecd9-955d-458f-89c1-03ee9912b155" processor="ee:transform">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="response" attributeName="doc:name" />
					<munit-tools:with-attribute whereValue="1156938a-bd29-4c2f-814c-16d44894c90f" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:after-call >
					<munit-tools:assert-that doc:name="Valid Sales Orders" doc:id="f7e31bee-67f4-4ea7-92f9-9c66173eabae" expression="#[payload.salesOrderStartedTotal]" is="#[MunitTools::equalTo(2)]"/>
					<munit-tools:assert-that doc:name="Invalid Sales Orders" doc:id="da1e3207-0df7-42be-adde-347d20ec12d4" is="#[MunitTools::equalTo(1)]" expression="#[payload.invalidSalesOrdersTotal]"/>
				</munit-tools:after-call>
			</munit-tools:spy>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Set Event" doc:id="b905f11f-8ea1-462b-8e36-b14cfd7d7349" >
				<munit:payload value="#[output application/json --- readUrl('classpath://sample_data/three_orders_one_invalid.json', 'application/json')]" />
			</munit:set-event>
			<flow-ref doc:name="queue-publish-message-for-processing" doc:id="ebe08b72-9d8d-46ff-90a2-4ddc3ffd5552" name="queue-publish-message-for-processing"/>
		</munit:execution>
		<munit:validation >
			<munit-tools:verify-call doc:name="Publish SalesOrdersQueue (2 Times)" doc:id="a226a428-048e-448c-9129-f5f6c7a513ac" processor="vm:publish" times="2">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="Publish SalesOrdersQueue" attributeName="doc:name" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
			<munit-tools:verify-call doc:name="Publish SalesOrdersErrorQueue (1 Time)" doc:id="e7bdfd11-af3a-489b-916b-f74318a7fc38" processor="vm:publish">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="Publish SalesOrdersErrorQueue" attributeName="doc:name" />
					<munit-tools:with-attribute whereValue="41257882-b557-4188-a6a6-a0a5e12ecf20" attributeName="doc:id" />
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>

</mule>
