<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<munit:config name="salesOrders-impl-test-suite.xml" />
	<munit:before-suite name="salesOrders-impl-test-suite" doc:id="ab946377-ace4-489a-8f06-c6fd8e3d312a" >
		<os:clear doc:name="Clear SalesOrder OS" doc:id="b2365b30-18ab-4474-862b-9a44a3175620" objectStore="SalesOrder_Object_Store"/>
		<munit-tools:mock-when doc:name="Create shipping order" doc:id="d1d9983c-231b-4f12-acd9-32dc7775ef7f" processor="bootcamp-shipping-system-api:create-shipping-order" >
			<munit-tools:with-attributes >
				<munit-tools:with-attribute whereValue="Create shipping order" attributeName="doc:name" />
			</munit-tools:with-attributes>
			<munit-tools:then-return >
				<munit-tools:payload value='#[&#10;output application/json&#10; --- &#10;{&#10;    "message": "Order SO111 has been successfully submitted for processing in the Shipping System",&#10;    "numberOfItems": 2,&#10;    "confirmationCode": "SHP123456-ABC11"&#10;}&#10;]' />
				<munit-tools:attributes value='#[{"statusCode":201}]' />
			</munit-tools:then-return>
		</munit-tools:mock-when>
		<munit-tools:mock-when doc:name="Create service scheduler" doc:id="38ec4101-4fbc-4e40-97fd-d3a3ce4904f0" processor="bootcamp-scheduler-system-api:create-service-scheduler" >
			<munit-tools:with-attributes >
				<munit-tools:with-attribute whereValue="Create service scheduler" attributeName="doc:name" />
			</munit-tools:with-attributes>
			<munit-tools:then-return >
				<munit-tools:payload value='#[&#10;output application/json&#10; --- &#10;{&#10;    "message": "Order SO111 has been successfully submitted for processing in the Scheduler System",&#10;    "confirmationCode": "SCH123456"&#10;}&#10;]' />
				<munit-tools:attributes value='#[{"statusCode":201}]' />
			</munit-tools:then-return>
		</munit-tools:mock-when>
		<munit-tools:mock-when doc:name="Send report" doc:id="335efb2e-f72f-49f5-9587-6e4f36713979" processor="sqs:send-message" >
			<munit-tools:with-attributes >
				<munit-tools:with-attribute whereValue="Send report" attributeName="doc:name" />
			</munit-tools:with-attributes>
		</munit-tools:mock-when>
		<set-payload value="#[output application/json --- readUrl('classpath://sample_data/one_order_products_and_services.json', 'application/json')]" doc:name="Set Payload" doc:id="d0e82174-7242-4147-8582-fa0a75a2b58b" />
		<flow-ref doc:name="sales-orders-impl-lineItems-proccesing" doc:id="1d676983-b25b-48be-be52-930e08a925c0" name="sales-orders-impl-lineItems-proccesing" />
		<set-payload value="#[output application/json --- readUrl('classpath://sample_data/one_order_invalid.json', 'application/json')]" doc:name="Set Payload invalid" doc:id="3db60dc3-5ec2-42bc-a6f7-862d79f047a1" />
		<flow-ref doc:name="REST queue-publish-message-for-processing" doc:id="e0e7fb6e-a77e-41db-aa61-83b4571d15d1" name="queue-publish-message-for-processing" />
	</munit:before-suite>
	<munit:test name="salesOrders-impl-test-suite-get-salesOrdersTest" doc:id="0da2dc38-78a3-4eef-b2d0-8b1824496d8f" description="Test">
		<munit:execution >
			<flow-ref doc:name="get-salesOrders" doc:id="fd5465f4-cf02-4738-b4d9-cdcc3ffc628d" name="get-salesOrders"/>
		</munit:execution>
		<munit:validation>
			<set-variable value='#[output application/json&#10; --- &#10;{&#10;  "message": "SUCCESS",&#10;  "salesOrders": [&#10;    {&#10;      "salesOrderId": "A1002",&#10;      "status": "COMPLETED"&#10;    },&#10;    {&#10;      "salesOrderId": "A1010",&#10;      "status": "INVALID"&#10;    }&#10;  ]&#10;}]' doc:name="Expected Payload" doc:id="6bb854fd-8a9b-4373-b009-4e54e3b97c11" variableName="expectedPayload"/>
			<munit-tools:assert-that doc:name="Verify Payload" doc:id="3c31b17a-1cc4-46f8-86b6-225e34ffaa33" is="#[MunitTools::equalTo(vars.expectedPayload)]" expression="#[payload]"/>
		</munit:validation>
	</munit:test>
	<munit:test name="salesOrders-impl-test-suite-get-salesOrder-by-salesOrderIdTest" doc:id="618dea16-8b08-466b-a5dc-b3a6b1f55407" description="Test">
		<munit:execution >
			<munit:set-event doc:name="Set Event" doc:id="3fb12bb4-2c80-4e1f-aac5-ae5f794ec5eb" >
				<munit:attributes value='#[{"uriParams":{"salesOrderId":"A1002"}}]' />
			</munit:set-event>
			<flow-ref doc:name="get-salesOrder-by-salesOrderId" doc:id="e05f3275-f512-4b1f-bdb1-d0958f62b206" name="get-salesOrder-by-salesOrderId"/>
		</munit:execution>
		<munit:validation>
			<set-variable value='#[output application/json&#10; --- &#10;{&#10;  "message": "SUCCESS",&#10;  "salesOrder": {&#10;    "salesOrderId": "A1002",&#10;    "status": "COMPLETED"&#10;  }&#10;}]' doc:name="Expected Payload" doc:id="42194a6c-5467-48af-92ac-637db49d2df1" variableName="expectedPayload" />
			<munit-tools:assert-that doc:name="Verify Payload" doc:id="155a46a9-4a4e-4ba2-bad9-e8e907d5dfeb" is="#[MunitTools::equalTo(vars.expectedPayload)]" expression="#[payload]" />
		</munit:validation>
	</munit:test>

</mule>
